// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/infrastructure/prisma/generated"
  moduleFormat = "cjs"
}

datasource db {
  provider  = "postgresql"
}

model User {
  id             String    @id @default(uuid())
  roleId         String
  email          String    @unique
  phone          String?   @unique
  hashedPassword String
  name           String?
  avatar         String?
  birthdate      DateTime?
  address        String?
  updatedAt      DateTime  @updatedAt
  createdAt      DateTime  @default(now())
  role           Role      @relation(fields: [roleId], references: [id], onDelete: Restrict)
  orders         Order[]

  @@map("users") // This will create a table named "users" in the database
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  type        String
  permissions String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User[]

  @@map("roles")
}

model Image {
  id        String   @id @default(uuid())
  title     String
  url       String
  format    String
  size      Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("images")
}

model Category {
  category_id String   @id @default(uuid())
  parent_id   String?
  name        String
  slug        String   @unique
  icon        String?
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Parent relationship (many-to-one)
  parent Category? @relation("CategoryParent", fields: [parent_id], references: [category_id])

  // Children relationship (one-to-many)
  children Category[] @relation("CategoryParent")

  // Products relationship (one-to-many)
  products Product[]

  @@index([parent_id])
  @@map("categories")
}

model Product {
  product_id  String   @id @default(uuid())
  category_id String
  name        String
  description String?
  thumbnail   String? // Extracted from first option's first image
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  category Category        @relation(fields: [category_id], references: [category_id], onDelete: Restrict)
  options  ProductOption[]

  @@index([category_id])
  @@map("products")
}

model ProductOption {
  option_id    String   @id @default(uuid())
  product_id   String
  name         String   @unique
  slug         String   @unique
  color        String // hex code
  color_family String // hex code
  images       String[]

  // Denormalized fields (derived from variants for performance)
  price        Int
  new_price    Int?
  out_of_stock Boolean @default(false)
  is_show      Boolean @default(true)

  search     String // Full-text search field
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  product  Product          @relation(fields: [product_id], references: [product_id], onDelete: Cascade)
  variants ProductVariant[]

  @@index([product_id])
  @@index([slug])
  @@map("product_options")
}

model ProductVariant {
  variant_id     String   @id @default(uuid())
  option_id      String
  sku            String   @unique
  size           String
  price          Int
  new_price      Int?
  stock_quantity Int      @default(0)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  option       ProductOption @relation(fields: [option_id], references: [option_id], onDelete: Cascade)
  orderDetails OrderDetail[]

  @@unique([option_id, size])
  @@index([option_id])
  @@map("product_variants")
}

enum EOrderStatus {
  PENDING_PAYMENT
  PENDING
  PROCESSING
  SHIPPING
  DELIVERED
  CANCELED
  RETURNED
}

model Order {
  order_id         String        @id @default(uuid())
  user_id          String
  order_code       String        @unique
  total_price      Int
  status           EOrderStatus  @default(PENDING)
  recipient_name   String
  phone_number     String
  shipping_address String
  email            String?
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt
  orderDetails     OrderDetail[]
  payment          Payment?

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("orders")
}

model OrderDetail {
  order_detail_id String         @id @default(uuid())
  order_id        String
  variant_id      String
  quantity        Int
  price_per_unit  Int
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt
  order           Order          @relation(fields: [order_id], references: [order_id], onDelete: SetNull)
  variant         ProductVariant @relation(fields: [variant_id], references: [variant_id], onDelete: Cascade)

  @@index([order_id])
  @@index([variant_id])
  @@map("order_details")
}

enum EPaymentStatus {
  PENDING
  CAPTURED
  FAILED
  REFUNDED
  CANCELED
}

model Payment {
  payment_id        String           @id @default(uuid())
  order_id          String           @unique
  payment_method_id String
  type              EPaymentMehod
  status            EPaymentStatus
  amount            Int
  created_at        DateTime         @default(now())
  updated_at        DateTime         @updatedAt
  order             Order            @relation(fields: [order_id], references: [order_id], onDelete: SetNull)
  paymentMethod     PaymentMethod    @relation(fields: [payment_method_id], references: [payment_method_id], onDelete: SetNull)
  attempts          PaymentAttempt[]

  @@index([payment_method_id])
  @@map("payments")
}

model PaymentAttempt {
  payment_attempt_id String               @id @default(uuid())
  payment_id         String
  payment_method_id  String
  type               EPaymentMehod
  order_number       Int
  status             EPaymentStatus
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt
  transactions       PaymentTransaction[]

  payment Payment @relation(fields: [payment_id], references: [payment_id], onDelete: SetNull)

  @@map("payment_attempts")
}

enum ETransactionType {
  INITIATED
  CAPTURED
  CANCELLED
  REFUNDED
  WEBHOOK
}

model PaymentTransaction {
  transaction_id     String           @id @default(uuid())
  payment_attempt_id String
  request_body       String
  response_body      String
  type               ETransactionType
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt

  paymentAttempt PaymentAttempt @relation(fields: [payment_attempt_id], references: [payment_attempt_id], onDelete: SetNull)

  @@index([payment_attempt_id])
  @@map("payment_transactions")
}

enum EPaymentMehod {
  CASH_ON_DELIVERY
  MOMO
}

model PaymentMethod {
  payment_method_id String        @id @default(uuid())
  display_name      String
  type              EPaymentMehod
  icon              String?
  description       String?
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  payments          Payment[]

  @@map("payment_methods")
}
